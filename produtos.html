<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Produtos - adorammus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://picsum.photos" />
    <link rel="icon" type="image/png" href="https://github.com/RCCxd/loja-dudu-e-kevin/blob/main/Logo%20Adorammus.png?raw=true" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="bg-gray-900 text-gray-100 page-products">
    <header class="site-header sticky top-0 z-10 bg-gray-900/90 backdrop-blur border-b border-gray-800">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <a href="index.html" class="inline-flex items-center">
            <img src="https://github.com/RCCxd/loja-dudu-e-kevin/blob/main/Logo%20Adorammus.png?raw=true" alt="adorammus" class="h-9 w-9 rounded-md border border-gray-800 object-cover" />
          </a>
          <h1 class="text-lg sm:text-xl font-semibold">Produtos</h1>
        </div>
        <div class="flex items-center gap-2 flex-wrap justify-end">
          <button id="btnAdmin" class="btn-secondary">Área do administrador</button>
          <button id="btnExportJSON" class="btn-secondary hidden" title="Exporta a lista atual para JSON">Exportar JSON</button>
          <button id="btnImportJSON" class="btn-secondary hidden" title="Importa um arquivo JSON">Importar JSON</button>
          <input id="fileImportJSON" type="file" accept="application/json" class="hidden" />
          <button id="btnCart" class="btn-secondary"><svg class="cart-ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 4h2l2.4 12.1a2 2 0 0 0 2 1.6h7.7a2 2 0 0 0 2-1.6L21 8H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="10" cy="20" r="1" fill="currentColor"/><circle cx="18" cy="20" r="1" fill="currentColor"/></svg><span data-cart-label>Carrinho</span> (<span data-cart-count>0</span>)</button>
        </div>
      </div>
    </header>

    <main class="page-section max-w-[1500px] mx-auto px-3 sm:px-4 py-8 sm:py-10 elevated">
      <div id="productGrid" class="product-grid"></div>
      <p id="emptyState" class="hidden text-center text-gray-400 py-16">Nenhum item encontrado.</p>
    </main>

    <!-- Hidden Netlify form so the platform recognizes the visit log submissions -->
    <form name="visit-log" data-netlify="true" netlify-honeypot="bot-field" hidden aria-hidden="true">
      <input type="hidden" name="form-name" value="visit-log" />
      <input type="text" name="page" />
      <input type="text" name="referrer" />
      <input type="text" name="userAgent" />
      <input type="text" name="ip" />
    </form>

    <!-- Admin Modal -->
    <div id="adminBackdrop" class="modal-backdrop hidden"></div>
    <div id="adminModal" class="modal hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Gerenciar itens</h2>
        <button id="btnCloseAdmin" class="icon-btn" title="Fechar">&times;</button>
      </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-medium">Lista</h3>
            <button id="btnAddNew" class="btn-secondary">Adicionar</button>
          </div>
          <div class="overflow-auto border border-gray-800 rounded">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-800">
                <tr>
                  <th class="px-3 py-2 text-left">Nome</th>
                  <th class="px-3 py-2 text-left">Modelos</th>
                  <th class="px-3 py-2 text-left">Cores</th>
                  <th class="px-3 py-2 text-left">Tamanhos</th>
                  <th class="px-3 py-2 text-left">Estoque</th>
                  <th class="px-3 py-2 text-right">Preco</th>
                  <th class="px-3 py-2 text-right">Acoes</th>
                </tr>
              </thead>
              <tbody id="adminTable" class="divide-y divide-gray-800"></tbody>
            </table>
          </div>
        </div>

        <form id="itemForm" class="space-y-3">
          <input type="hidden" id="fieldId" />
          <div>
            <label class="label" for="fieldName">Nome</label>
            <input id="fieldName" class="input" type="text" placeholder="Nome do produto" required />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="label" for="fieldPrice">Preco (R$)</label>
              <input id="fieldPrice" class="input" type="number" step="0.01" min="0" placeholder="0,00" required />
            </div>
            <div>
              <div class="flex items-center justify-between gap-2">
                <label class="label mb-0" for="fieldSizes">Tamanhos (separados por virgula)</label>
                <label class="inline-flex items-center gap-2 text-xs cursor-pointer">
                  <input id="fieldHasSizes" type="checkbox" class="accent-indigo-500" checked />
                  <span>Variar tamanhos</span>
                </label>
              </div>
              <input id="fieldSizes" class="input" type="text" placeholder="P,M,G" />
            </div>
          </div>
          <div>
            <div class="flex items-center justify-between gap-3 mb-2">
              <label class="label mb-0" for="fieldColors">Cores disponiveis</label>
              <button type="button" id="btnAddColor" class="btn-secondary text-xs px-2 py-1">Adicionar cor</button>
            </div>
            <div id="colorList" class="space-y-2">
              <div class="flex items-center gap-2" data-color-row>
                <input type="text" class="input flex-1" placeholder="Nome" data-color-name />
                <input type="text" class="input w-28" placeholder="#hex" data-color-swatch />
                <button type="button" class="btn-danger text-sm px-3" data-remove-color>&times;</button>
              </div>
            </div>
            <p class="text-xs text-gray-400 mt-1">Informe o nome, o hex opcional (ex.: Preto / #000000) e, se quiser, uma URL de imagem especifica. Deixe todos em branco para remover.</p>
            <input id="fieldColors" type="hidden" />
          </div>
          <div>
            <label class="label" for="fieldImage">URL da Imagem</label>
            <input id="fieldImage" class="input" type="url" placeholder="https://..." />
          </div>
          <div>
            <label class="label" for="fieldImageAlt">URL da Imagem Alternativa (normal)</label>
            <input id="fieldImageAlt" class="input" type="url" placeholder="https://..." />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="label" for="fieldImageMale">URL da Imagem Masculino</label>
              <input id="fieldImageMale" class="input" type="url" placeholder="https://..." />
            </div>
            <div>
              <label class="label" for="fieldImageFemale">URL da Imagem Feminino</label>
              <input id="fieldImageFemale" class="input" type="url" placeholder="https://..." />
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <label class="inline-flex items-center gap-2 text-sm cursor-pointer">
              <input id="fieldShowMale" type="checkbox" class="accent-indigo-500" checked />
              <span>Mostrar modelo masculino</span>
            </label>
            <label class="inline-flex items-center gap-2 text-sm cursor-pointer">
              <input id="fieldShowFemale" type="checkbox" class="accent-indigo-500" checked />
              <span>Mostrar modelo feminino</span>
            </label>
            <label class="inline-flex items-center gap-2 text-sm cursor-pointer sm:col-span-2">
              <input id="fieldInStock" type="checkbox" class="accent-indigo-500" checked />
              <span>Disponivel (desmarque para marcar como fora de estoque)</span>
            </label>
          </div>
          <div>
            <label class="label" for="fieldDesc">Descricao</label>
            <textarea id="fieldDesc" class="input min-h-[96px]" placeholder="Breve descricao"></textarea>
          </div>
          <div class="flex items-center justify-end gap-2">
            <button id="btnDelete" type="button" class="btn-danger hidden">Excluir</button>
            <button id="btnSave" type="submit" class="btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartBackdrop" class="modal-backdrop hidden"></div>
    <div id="cartModal" class="modal hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Seu carrinho</h2>
        <button id="btnCloseCart" class="icon-btn" title="Fechar">&times;</button>
      </div>
      <div id="cartItems" class="divide-y divide-gray-800"></div>
      <div class="flex items-center justify-between mt-4">
        <div class="text-right ml-auto">
          <div class="text-sm text-gray-400">Total</div>
          <div id="cartTotal" class="text-xl font-bold">R$ 0,00</div>
        </div>
      </div>
      <div class="flex items-center justify-end gap-2 mt-4">
        <button id="btnClearCart" class="btn-secondary">Esvaziar</button>
        <button id="btnCheckout" class="btn-primary">Finalizar compra</button>
      </div>
    </div>

        <script src="store.js"></script>
    <script>
      const grid = document.getElementById('productGrid');
      const emptyState = document.getElementById('emptyState');
      let gender = Store.getGender();
      let flipTimer = null;
      const FLIP_INTERVAL = 5000;
      const htmlEscape = (str = '') => String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
      const safeColorValue = (val) => String(val ?? '').replace(/["<>]/g, '').replace(/;/g, '');

      function flipProductImages() {
        document.querySelectorAll('img[data-img-primary][data-img-secondary]').forEach((img) => {
          const primary = img.getAttribute('data-img-primary');
          const secondary = img.getAttribute('data-img-secondary') || primary;
          if (!primary || !secondary || primary === secondary) return;
          const current = img.getAttribute('data-img-state') || 'primary';
          const next = current === 'primary' ? 'secondary' : 'primary';
          img.setAttribute('src', next === 'primary' ? primary : secondary);
          img.setAttribute('data-img-state', next);
        });
      }
      function ensureFlipLoop() {
        if (flipTimer) clearInterval(flipTimer);
        flipTimer = setInterval(flipProductImages, FLIP_INTERVAL);
      }

      function genderOptions(p) {
        return [
          { key: 'feminino', label: 'Feminino', enabled: p.showFemale !== false },
          { key: 'masculino', label: 'Masculino', enabled: p.showMale !== false },
        ].filter(g => g.enabled);
      }
      function colorSwatches(p) {
        const list = Array.isArray(p.colors) ? p.colors : [];
        if (!list.length) return '';
        const visible = list.slice(0, 6);
        const dots = visible.map(col => {
          const safeName = htmlEscape(col?.name || 'Cor');
          const swatch = safeColorValue(col?.swatch || '');
          const style = swatch ? ` style="--dot-color:${swatch}"` : '';
          return `<span class="color-dot"${style} title="${safeName}"></span>`;
        }).join('');
        const extra = list.length > visible.length
          ? `<span class="color-dot color-dot-more" title="${htmlEscape((list.length - visible.length) + ' cores extras')}">+${list.length - visible.length}</span>`
          : '';
        return `<div class="color-dot-list" aria-label="Cores disponiveis">${dots}${extra}</div>`;
      }
      function colorsToInputValue(list) {
        if (!Array.isArray(list)) return '';
        return list.map(col => {
          if (!col) return '';
          const name = col.name || '';
          const swatch = col.swatch || '';
          return swatch ? `${name}:${swatch}` : name;
        }).filter(Boolean).join(',');
      }
      function getColorRows() {
        if (!colorList) return [];
        return Array.from(colorList.querySelectorAll('[data-color-row]')).map((row) => {
          const name = row.querySelector('[data-color-name]')?.value.trim() || '';
          const swatch = row.querySelector('[data-color-swatch]')?.value.trim() || '';
          const image = row.querySelector('[data-color-image]')?.value.trim() || '';
          if (!name && !swatch && !image) return null;
          const payload = { name: name || swatch || 'Variante', swatch: swatch || null };
          if (image) payload.image = image;
          return payload;
        }).filter(Boolean);
      }
      function syncColorField() {
        if (fieldColors) fieldColors.value = colorsToInputValue(getColorRows());
      }
      function addColorRow(data = {}) {
        if (!colorList) return;
        const row = document.createElement('div');
        row.className = 'flex flex-wrap items-center gap-2';
        row.setAttribute('data-color-row', '1');
        row.innerHTML = `
          <input type="text" class="input flex-1 min-w-[140px]" placeholder="Nome" value="${data.name || ''}" data-color-name />
          <input type="text" class="input w-28" placeholder="#hex" value="${data.swatch || ''}" data-color-swatch />
          <input type="url" class="input flex-1 min-w-[200px]" placeholder="URL da imagem (opcional)" value="${data.image || ''}" data-color-image />
          <button type="button" class="btn-danger text-sm px-3" data-remove-color>&times;</button>
        `;
        colorList.appendChild(row);
        syncColorField();
      }
      function renderColorRows(list) {
        if (!colorList) return;
        colorList.innerHTML = '';
        const hasList = Array.isArray(list) && list.length;
        if (hasList) list.forEach(item => addColorRow(item));
        else addColorRow();
        syncColorField();
      }

      function card(p) {
        const options = genderOptions(p);
        const hasGenderOptions = options.length > 0;
        const chosenGender = hasGenderOptions ? (Store.pickGender(p, gender) || options[0]?.key || 'masculino') : null;
        const baseImages = Store.getBaseImages(p);
        const basePrimary = baseImages[0];
        const baseSecondary = baseImages[1] || baseImages[0];
        const fallback = Store.placeholderImg(p.name || 'item');
        const primaryImg = hasGenderOptions ? Store.getImageByGender(p, chosenGender) : basePrimary;
        const secondaryImg = hasGenderOptions ? basePrimary : baseSecondary;
        const safePrimary = primaryImg || fallback;
        const safeSecondary = secondaryImg || safePrimary;
        const genderButtons = hasGenderOptions ? `
              <div class="card-actions gender-toggle flex flex-wrap gap-2">
                ${options.map(opt => `<button class="icon-btn ${chosenGender===opt.key ? 'bg-indigo-600 border-transparent text-white' : ''}" data-card-gender="${opt.key}" data-id="${p.id}">${opt.label}</button>`).join('')}
              </div>` : '';
        const colorDots = colorSwatches(p);
        const outOfStock = p.inStock === false;
        const priceBlock = `
          <div class="text-right">
            <span class="card-price text-xl ${outOfStock ? 'opacity-70 line-through' : ''}">${Store.fmtBRL(p.price)}</span>
            ${outOfStock ? '<div class="card-stock-label">Fora de estoque</div>' : ''}
          </div>`;
        return `
          <article class="card product-card ${outOfStock ? 'card-out' : ''} anim-up hover-lift" data-card="${p.id}">
            <div class="relative">
              ${''}
              <img src="${safePrimary}" alt="${p.name}"
                   loading="lazy" decoding="async"
                   onerror="this.src=this.dataset.fallback;"
                   data-fallback="${fallback}"
                   data-img-primary="${safePrimary}" data-img-secondary="${safeSecondary}" data-img-state="primary" data-go="${p.id}"
                   class="product-card-media object-cover cursor-pointer" />
            </div>
            <div class="card-body space-y-3">
              <div class="flex items-start justify-between gap-3">
                <h3 class="card-title text-lg font-semibold">${p.name}</h3>
                ${priceBlock}
              </div>
              ${p.description ? `<p class="card-desc">${p.description}</p>` : ''}
              ${colorDots}
              ${genderButtons}
            </div>
          </article>`;
      }

      function render() {
        const list = Store.getProducts();
        if (!list.length) {
          grid.innerHTML = '';
          emptyState.classList.remove('hidden');
          return;
        }
        emptyState.classList.add('hidden');
        grid.innerHTML = list.map(card).join('');
        ensureFlipLoop();
      }

      document.addEventListener('click', (e) => {
        const t = e.target;
        if (!(t instanceof Element)) return;
        const go = t.closest('[data-go]');
        if (go) {
          const id = go.getAttribute('data-go');
          window.location.href = `produto.html?id=${encodeURIComponent(id)}`;
        }
      });

      document.addEventListener('DOMContentLoaded', async () => {
        await (window.Store?.initFromRemote?.() || Promise.resolve(false));
        render();
        ensureFlipLoop();
      });
      document.addEventListener('mouseover', (e) => {
        const t = e.target;
        if (!(t instanceof Element)) return;
        const img = t.closest('img[data-img-primary]');
        if (img) {
          const secondary = img.getAttribute('data-img-secondary');
          const primary = img.getAttribute('data-img-primary');
          if (secondary && secondary !== primary) {
            img.setAttribute('src', secondary);
            img.setAttribute('data-img-state', 'secondary');
          }
        }
      });
      document.addEventListener('mouseout', (e) => {
        const t = e.target;
        if (!(t instanceof Element)) return;
        const img = t.closest('img[data-img-primary]');
        if (img) {
          const primary = img.getAttribute('data-img-primary');
          if (primary) img.setAttribute('src', primary);
          img.setAttribute('data-img-state', 'primary');
        }
      });
      document.addEventListener('click', (e) => {
        const t = e.target;
        if (!(t instanceof Element)) return;
        const gbtn = t.closest('[data-card-gender]');
        if (gbtn) {
          const sel = gbtn.getAttribute('data-card-gender') === 'feminino' ? 'feminino' : 'masculino';
          const pid = gbtn.getAttribute('data-id');
          const card = gbtn.closest('[data-card]');
          if (pid && card) {
            gender = sel;
            Store.setGender(gender);
            const p = Store.getProduct(pid);
            const img = card.querySelector('img[data-img-primary]');
            if (p && img) {
              const next = Store.getImageByGender(p, sel);
              const baseImages = Store.getBaseImages(p);
              const basePrimary = baseImages[0];
              img.setAttribute('src', next || basePrimary);
              img.setAttribute('data-img-primary', next || basePrimary);
              img.setAttribute('data-img-secondary', basePrimary || next);
              img.setAttribute('data-img-state', 'primary');
            }
            card.querySelectorAll('[data-card-gender]').forEach(b => {
              const g = b.getAttribute('data-card-gender');
              if (g === sel) b.classList.add('bg-indigo-600','border-transparent','text-white');
              else b.classList.remove('bg-indigo-600','border-transparent','text-white');
            });
            ensureFlipLoop();
          }
        }
      });

      // Admin editor
      const adminBackdrop = document.getElementById('adminBackdrop');
      const adminModal = document.getElementById('adminModal');
      const btnAdmin = document.getElementById('btnAdmin');
      const btnCloseAdmin = document.getElementById('btnCloseAdmin');
      const adminTable = document.getElementById('adminTable');
      const btnAddNew = document.getElementById('btnAddNew');
      const btnExportJSON = document.getElementById('btnExportJSON');
      const btnImportJSON = document.getElementById('btnImportJSON');
      const fileImportJSON = document.getElementById('fileImportJSON');
      const itemForm = document.getElementById('itemForm');
      const fieldId = document.getElementById('fieldId');
      const fieldName = document.getElementById('fieldName');
      const fieldPrice = document.getElementById('fieldPrice');
      const fieldSizes = document.getElementById('fieldSizes');
      const fieldColors = document.getElementById('fieldColors');
      const colorList = document.getElementById('colorList');
      const btnAddColor = document.getElementById('btnAddColor');
      const fieldHasSizes = document.getElementById('fieldHasSizes');
      const fieldImage = document.getElementById('fieldImage');
      const fieldImageAlt = document.getElementById('fieldImageAlt');
      const fieldImageMale = document.getElementById('fieldImageMale');
      const fieldImageFemale = document.getElementById('fieldImageFemale');
      const fieldShowMale = document.getElementById('fieldShowMale');
      const fieldShowFemale = document.getElementById('fieldShowFemale');
      const fieldInStock = document.getElementById('fieldInStock');
      const fieldDesc = document.getElementById('fieldDesc');
      const btnDelete = document.getElementById('btnDelete');

      const ADMIN_STORAGE_KEY = 'adorammus_admin';
      const ADMIN_PASSWORD = 'SafireIM'; // altere se desejar

      function isAdmin() {
        return localStorage.getItem(ADMIN_STORAGE_KEY) === '1';
      }
      function setAdminFlag(enabled) {
        localStorage.setItem(ADMIN_STORAGE_KEY, enabled ? '1' : '0');
      }
      function applyAdminVisibility() {
        const show = isAdmin();
        [btnExportJSON, btnImportJSON].forEach((el) => {
          if (!el) return;
          if (show) el.classList.remove('hidden');
          else el.classList.add('hidden');
        });
      }
      function ensureAdmin() {
        if (isAdmin()) return true;
        const pwd = prompt(`Area do administrador

Informe a senha:`);
        if (!pwd) return false;
        if (pwd !== ADMIN_PASSWORD) {
          alert('Senha incorreta.');
          return false;
        }
        setAdminFlag(true);
        applyAdminVisibility();
        return true;
      }

      applyAdminVisibility();
      renderColorRows([]);

      function openAdmin() {
        if (!isAdmin()) return;
        adminBackdrop.classList.remove('hidden');
        adminModal.classList.remove('hidden');
        adminModal.classList.add('anim-scale');
        renderAdminTable();
        fillForm(null);
        btnDelete.classList.add('hidden');
      }
      function closeAdmin() {
        adminBackdrop.classList.add('hidden');
        adminModal.classList.add('hidden');
      }
      function formatModels(p) {
        const items = [];
        if (p.showFemale !== false) items.push('Fem');
        if (p.showMale !== false) items.push('Masc');
        return items.length ? items.join(' / ') : 'Base';
      }
      function formatColors(p) {
        const list = Array.isArray(p.colors) ? p.colors : [];
        if (!list.length) return '-';
        return list.map(c => c?.name || '').filter(Boolean).join(', ') || '-';
      }
      function formatStock(p) {
        return p.inStock === false ? 'Sem estoque' : 'Disponivel';
      }
      function renderAdminTable() {
        const list = Store.getProducts();
        adminTable.innerHTML = list.map(p => `
          <tr>
            <td class="px-3 py-2">${p.name}</td>
            <td class="px-3 py-2">${formatModels(p)}</td>
            <td class="px-3 py-2">${formatColors(p)}</td>
            <td class="px-3 py-2">${p.hasSizes === false ? 'Unico' : (p.sizes||[]).join(', ')}</td>
            <td class="px-3 py-2">${formatStock(p)}</td>
            <td class="px-3 py-2 text-right">${Store.fmtBRL(p.price)}</td>
            <td class="px-3 py-2 text-right">
              <button class="btn-secondary" data-edit="${p.id}">Editar</button>
            </td>
          </tr>
        `).join('');
      }
      function toggleSizeField() {
        const enabled = fieldHasSizes?.checked !== false;
        if (fieldSizes) {
          fieldSizes.disabled = !enabled;
          fieldSizes.classList.toggle('opacity-60', !enabled);
        }
      }
      function fillForm(p) {
        fieldId.value = p?.id || '';
        fieldName.value = p?.name || '';
        fieldPrice.value = p?.price != null ? String(p.price) : '';
        fieldSizes.value = (p?.sizes || []).join(',');
        fieldHasSizes.checked = p?.hasSizes === false ? false : true;
        toggleSizeField();
        renderColorRows(p?.colors || []);
        fieldImage.value = p?.image || '';
        if (fieldImageAlt) fieldImageAlt.value = p?.imageAlt || '';
        if (fieldImageMale) fieldImageMale.value = p?.imageMale || '';
        if (fieldImageFemale) fieldImageFemale.value = p?.imageFemale || '';
        if (fieldShowMale) fieldShowMale.checked = p?.showMale !== false;
        if (fieldShowFemale) fieldShowFemale.checked = p?.showFemale !== false;
        if (fieldInStock) fieldInStock.checked = p?.inStock === false ? false : true;
        fieldDesc.value = p?.description || '';
      }

      btnAdmin?.addEventListener('click', () => {
        if (!ensureAdmin()) return;
        openAdmin();
      });
      btnCloseAdmin?.addEventListener('click', closeAdmin);
      adminBackdrop?.addEventListener('click', closeAdmin);
      btnAddNew?.addEventListener('click', () => {
        fillForm(null);
        btnDelete.classList.add('hidden');
      });
      btnAddColor?.addEventListener('click', () => {
        addColorRow();
      });
      colorList?.addEventListener('click', (e) => {
        const t = e.target;
        if (!(t instanceof Element)) return;
        const rem = t.closest('[data-remove-color]');
        if (rem) {
          const row = rem.closest('[data-color-row]');
          row?.remove();
          if (!colorList.querySelector('[data-color-row]')) addColorRow();
          syncColorField();
        }
      });
      colorList?.addEventListener('input', () => syncColorField());

      fieldHasSizes?.addEventListener('change', toggleSizeField);

      btnExportJSON?.addEventListener('click', () => {
        if (!ensureAdmin()) return;
        try {
          const data = Store.getProducts();
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'products.json';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(a.href);
          alert('Arquivo products.json exportado. Coloque-o em data/products.json e faca commit no GitHub.');
        } catch (e) {
          alert('Falha ao exportar JSON.');
        }
      });
      btnImportJSON?.addEventListener('click', () => {
        if (!ensureAdmin()) return;
        fileImportJSON?.click();
      });
      fileImportJSON?.addEventListener('change', async (e) => {
        if (!isAdmin()) { e.target.value = ''; return; }
        const file = e.target.files?.[0];
        if (!file) return;
        try {
          const text = await file.text();
          const list = JSON.parse(text);
          Store.setProducts(list);
          render();
          renderAdminTable();
          alert('Produtos importados. Para compartilhar, exporte e faca commit em data/products.json.');
        } catch {
          alert('JSON invalido.');
        } finally {
          e.target.value = '';
        }
      });

      document.addEventListener('click', (e) => {
        const t = e.target;
        if (!(t instanceof Element)) return;
        const ed = t.closest('[data-edit]');
        if (ed) {
          const id = ed.getAttribute('data-edit');
          const p = Store.getProduct(id);
          if (p) { fillForm(p); btnDelete.classList.remove('hidden'); }
        }
      });

      itemForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        const hasSizes = fieldHasSizes?.checked !== false;
        const colorEntries = getColorRows();
        const patch = {
          id: fieldId.value || undefined,
          name: fieldName.value.trim(),
          price: Number(fieldPrice.value),
          sizes: hasSizes ? fieldSizes.value : '',
          hasSizes,
          colors: colorEntries,
          image: fieldImage.value.trim(),
          imageAlt: (fieldImageAlt?.value || '').trim(),
          imageMale: (fieldImageMale?.value || '').trim(),
          imageFemale: (fieldImageFemale?.value || '').trim(),
          showMale: fieldShowMale?.checked !== false,
          showFemale: fieldShowFemale?.checked !== false,
          inStock: fieldInStock?.checked !== false,
          description: fieldDesc.value.trim()
        };
        if (fieldColors) fieldColors.value = colorsToInputValue(colorEntries);
        if (patch.id) {
          Store.updateProduct(patch.id, patch);
        } else {
          Store.addProduct(patch);
        }
        render();
        renderAdminTable();
        itemForm.reset();
        fieldHasSizes.checked = true;
        toggleSizeField();
        if (fieldShowMale) fieldShowMale.checked = true;
        if (fieldShowFemale) fieldShowFemale.checked = true;
        if (fieldInStock) fieldInStock.checked = true;
        renderColorRows([]);
        btnDelete.classList.add('hidden');
      });
      btnDelete?.addEventListener('click', () => {
        const id = fieldId.value;
        if (id && confirm('Excluir este item?')) {
          Store.removeProduct(id);
          render();
          renderAdminTable();
          itemForm.reset();
          fieldHasSizes.checked = true;
          toggleSizeField();
          if (fieldShowMale) fieldShowMale.checked = true;
          if (fieldShowFemale) fieldShowFemale.checked = true;
          if (fieldInStock) fieldInStock.checked = true;
          renderColorRows([]);
          btnDelete.classList.add('hidden');
        }
      });
    </script>
    <script>
      (function setupVisitLogging() {
        const FORM_NAME = 'visit-log';
        const STORAGE_KEY = `visit-log:${window.location.pathname}`;
        if (sessionStorage.getItem(STORAGE_KEY)) return;

        const encode = (data) => Object.keys(data)
          .map((key) => `${encodeURIComponent(key)}=${encodeURIComponent(data[key] ?? '')}`)
          .join('&');

        async function enrichWithIp(details) {
          try {
            const res = await fetch('https://api.ipify.org?format=json');
            if (res.ok) {
              const data = await res.json();
              if (data?.ip) details.ip = data.ip;
            }
          } catch (err) {
            console.warn('Falha ao buscar o IP publico', err);
          }
          return details;
        }

        async function collectDetails() {
          const payload = {
            'form-name': FORM_NAME,
            page: `${location.pathname}${location.search}`,
            fullUrl: location.href,
            referrer: document.referrer || 'acesso direto',
            timestamp: new Date().toISOString(),
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || '',
            language: navigator.language || '',
            languages: (navigator.languages || []).join(','),
            userAgent: navigator.userAgent || '',
            platform: navigator.platform || '',
            screen: `${window.screen?.width || 0}x${window.screen?.height || 0}`,
            viewport: `${window.innerWidth}x${window.innerHeight}`,
            cookies: navigator.cookieEnabled ? 'habilitado' : 'desabilitado',
            online: navigator.onLine ? 'online' : 'offline',
            botField: '',
            sessionId: (crypto?.randomUUID?.() || `${Date.now()}-${Math.random()}`)
          };
          return enrichWithIp(payload);
        }

        async function submitLog() {
          const payload = await collectDetails();
          try {
            await fetch('/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: encode(payload)
            });
            sessionStorage.setItem(STORAGE_KEY, '1');
          } catch (err) {
            console.warn('Falha ao registrar o log de visita', err);
          }
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', submitLog, { once: true });
        } else {
          submitLog();
        }
      })();
    </script>
    <script src="script.js"></script>
      <footer class="footer-band">
      <div class="max-w-7xl mx-auto px-4 py-8 text-sm flex items-center justify-between">
        <div class="text-gray-600">&copy; 2025 adorammus</div>
        <div class="text-gray-600">Feito com carinho</div>
      </div>
      <div class="max-w-7xl mx-auto px-4 pb-8 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 text-sm">
        <div class="text-gray-500">Developed by</div>
        <a
          href="https://www.instagram.com/renan_cavalcantic"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-indigo-500/50 bg-indigo-500/10 text-indigo-100 hover:bg-indigo-500/20 hover:border-indigo-400 transition-colors duration-150"
        >
          <svg
            class="w-5 h-5"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <rect x="3" y="3" width="18" height="18" rx="5" ry="5" stroke="currentColor" stroke-width="1.6" />
            <circle cx="12" cy="12" r="4.2" stroke="currentColor" stroke-width="1.6" />
            <circle cx="17" cy="7" r="1.2" fill="currentColor" />
          </svg>
          <span class="font-medium">@renan_cavalcantic</span>
        </a>
      </div>
      <div class="max-w-7xl mx-auto px-4 pb-8 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 text-sm">
        <div class="text-gray-500">Developed by</div>
        <a
          href="https://guns.lol/volqq"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-emerald-500/50 bg-emerald-500/10 text-emerald-100 hover:bg-emerald-500/20 hover:border-emerald-400 transition-colors duration-150"
        >
          <svg
            class="w-5 h-5"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <rect x="3" y="3" width="18" height="18" rx="5" ry="5" stroke="currentColor" stroke-width="1.6" />
            <path d="M8 12h8M12 8v8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
          </svg>
          <span class="font-medium">guns.lol/volqq</span>
        </a>
      </div>
    </footer>
  </body>
